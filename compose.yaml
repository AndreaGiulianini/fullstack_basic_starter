services:
  traefik:
    image: "traefik:3.6.7"
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./letsencrypt:/letsencrypt"
    depends_on:
      - app
      - api

  app:
    build:
      context: ./app
      target: "${ENV:-development}"
    image: app
    container_name: app
    volumes:
      - ./app:/app
      - /app/node_modules
    labels:
      - traefik.enable=true
      - traefik.http.routers.app.rule=PathPrefix(`/`)
      - traefik.http.routers.app.priority=1
      - traefik.http.services.app.loadbalancer.server.port=${APP_PORT:-4200}
    environment:
      TZ: Europe/Rome
    restart: always

  api:
    build:
      context: ./api
      target: "${ENV:-development}"
    image: api
    container_name: api
    volumes:
      - ./api:/src
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=PathPrefix(`/api`)
      - traefik.http.routers.api.priority=10
      - traefik.http.routers.swagger.rule=PathPrefix(`/swagger`)
      - traefik.http.routers.swagger.priority=10
      - traefik.http.services.api.loadbalancer.server.port=5000
    environment:
      ASPNETCORE_ENVIRONMENT: "${ASPNETCORE_ENVIRONMENT:-Development}"
      ConnectionStrings__DefaultConnection: "Host=${DB_HOST};Database=${DB_NAME};Username=${DB_USER};Password=${DB_PASS}"
      Jwt__Secret: "${JWT_SECRET}"
      Jwt__Issuer: "fullstack-api"
      Jwt__Audience: "fullstack-app"
      Redis__ConnectionString: "${VALKEY_HOST}:${VALKEY_PORT},password=${VALKEY_PASS}"
      Elasticsearch__Uri: "http://${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}"
      Cors__AllowedOrigins: "http://localhost:4200,http://localhost:80"
    restart: always
